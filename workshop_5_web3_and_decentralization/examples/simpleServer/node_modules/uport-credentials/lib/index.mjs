import{ec as e}from"elliptic";import r from"uport-did-resolver";import t from"ethr-did-resolver";import i from"https-did-resolver";import n from"uport-lite";import{isMNID as o,decode as a}from"mnid";import{createJWT as c,verifyJWT as s,SimpleSigner as u,toEthereumAddress as d}from"did-jwt";export{SimpleSigner}from"did-jwt";var l,p;!function(e){e.Function="function",e.Event="event",e.Constructor="constructor",e.Fallback="fallback"}(l||(l={})),function(e){e.Pure="pure",e.View="view",e.NonPayable="nonpayable",e.Payable="payable"}(p||(p={}));var f,v=function(e,r){for(var t=e.name+"(",i=e.inputs||[],n=0;n<i.length;n++){var o=i[n],a=o.type+" ";t+=a+="string"===o.type?'"'+r[n]+'"':""+r[n],i.length-1!==n&&(t+=", ")}return t+")"},h=function(e){return function(r){return{at:function(t){var i={};return function(e){return e.filter(function(e){return e.type===l.Function&&e.name&&!e.constant})}(r).forEach(function(r){r.name&&(i[r.name]=function(){var i={},n=[].slice.call(arguments),o=(r.inputs||[]).length;(function(e){if("object"!=typeof e)return!1;if(0===Object.keys(e).length)return!0;for(var r=0,t=["from","to","data","value","gasPrice","gas"];r<t.length;r+=1)if(t[r]in e)return!0;return!1})(n[o])&&(i=n.splice(o,1)[0]);var a=Object.assign({},i,{to:t,function:v(r,n)});return e?e(a,n[n.length-1]):a})}),Object.assign({},i,{abi:r,address:t})}}}},y=new e("secp256k1");!function(e){e.DISCLOSURE_REQUEST="shareReq",e.DISCLOSURE_RESPONSE="shareResp",e.TYPED_DATA_SIGNATURE_REQUEST="eip712Req",e.VERIFICATION_SIGNATURE_REQUEST="verReq",e.ETH_TX_REQUEST="ethtx",e.PERSONAL_SIGN_REQUEST="personalSigReq"}(f||(f={}));var m=function(e){var a,c=e.did,s=e.address,l=e.privateKey,p=e.signer,f=e.networks,v=e.registry,h=e.ethrConfig;if(p?this.signer=p:l&&(this.signer=u(l)),c)this.did=c;else if(s)o(s)&&(this.did="did:uport:"+s),s.match("^0x[0-9a-fA-F]{40}$")&&(this.did="did:ethr:"+s);else if(l){var m=y.keyFromPrivate(l),E=d(m.getPublic("hex"));this.did="did:ethr:"+E}r(v||n({networks:f?(a=f,Object.keys(a).forEach(function(e){var r=a[e];if("object"!=typeof r)throw new Error("Network configuration object required");["registry","rpcUrl"].forEach(function(e){if(!r.hasOwnProperty(e))throw new Error("Malformed network config object, object must have '"+e+"' key specified.")})}),a):{}})),t(h||{}),i()};m.createIdentity=function(){var e=y.genKeyPair(),r=e.getPublic("hex"),t=e.getPrivate("hex");return{did:"did:ethr:"+d(r),privateKey:t}},m.prototype.signJWT=function(e,r){return this.did&&this.signer?c(e,{issuer:this.did,signer:this.signer,alg:this.did.match("^did:uport:")||o(this.did)?"ES256K":"ES256K-R",expiresIn:r}):Promise.reject(new Error("No Signing Identity configured"))},m.prototype.createDisclosureRequest=function(e,r){void 0===e&&(e={}),void 0===r&&(r=600);var t={};if(e.requested&&(t.requested=e.requested),e.verified&&(t.verified=e.verified),e.claims&&(t.claims=e.claims),e.notifications&&(t.permissions=["notifications"]),e.callbackUrl&&(t.callback=e.callbackUrl),e.networkId&&(t.net=e.networkId),e.rpcUrl){if(!e.networkId)return Promise.reject(new Error("rpcUrl was specified but no networkId"));t.rpc=e.rpcUrl}if(e.vc&&(t.vc=e.vc),e.exp&&(t.exp=e.exp),e.accountType){if(!(["general","segregated","keypair","none"].indexOf(e.accountType)>=0))return Promise.reject(new Error("Unsupported accountType "+e.accountType));t.act=e.accountType}return this.signJWT(Object.assign({},t,{type:f.DISCLOSURE_REQUEST}),e.exp?void 0:r)},m.prototype.createVerification=function(e){return this.signJWT({sub:e.sub,claim:e.claim,exp:e.exp,vc:e.vc,callbackUrl:e.callbackUrl})},m.prototype.createVerificationSignatureRequest=function(e,r){return this.signJWT({unsignedClaim:e,sub:r.sub,riss:r.riss,aud:r.aud,vc:r.vc,callback:r.callbackUrl,type:f.VERIFICATION_SIGNATURE_REQUEST,rexp:r.rexp},r.expiresIn)},m.prototype.createTypedDataSignatureRequest=function(e,r){void 0===r&&(r={});var t=r.from,i=r.net,n=r.callback;try{for(var o=0,a=["types","primaryType","message","domain"];o<a.length;o+=1){var c=a[o];if(!e[c])throw new Error("Invalid EIP712 Request, must include '"+c+"'")}return Promise.resolve(this.signJWT({typedData:e,from:t,net:i,callback:n,type:f.TYPED_DATA_SIGNATURE_REQUEST}))}catch(e){return Promise.reject(e)}},m.prototype.createPersonalSignRequest=function(e,r){return void 0===r&&(r={}),this.signJWT({data:e,from:r.from,net:r.net,callback:r.callback,type:f.PERSONAL_SIGN_REQUEST})},m.prototype.createTxRequest=function(e,r){void 0===r&&(r={});var t=r.callbackUrl,i=r.exp;void 0===i&&(i=600);var n=r.networkId,o=r.label,a={};return t&&(a.callback=t),n&&(a.net=n),o&&(a.label=o),this.signJWT(Object.assign({},a,e,{type:f.ETH_TX_REQUEST}),i)},m.prototype.createDisclosureResponse=function(e,r){void 0===e&&(e={}),void 0===r&&(r=600);try{var t=this;function i(){return t.signJWT(Object.assign({},e,{type:f.DISCLOSURE_RESPONSE}),r)}var n=function(){if(e.req)return Promise.resolve(s(e.req)).then(function(r){r.issuer&&(e.aud=r.issuer)})}();return n&&n.then?n.then(i):i()}catch(e){return Promise.reject(e)}},m.prototype.processDisclosurePayload=function(e){var r=e.doc,t=e.payload;try{var i=this,n=t.own;void 0===n&&(n={});var o=t.capabilities;void 0===o&&(o=[]);var c=t.nad,u=t.dad,d=t.iss,l=t.boxPub,p=t.verified,f=function(e,r){var t={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&-1===r.indexOf(i)&&(t[i]=e[i]);return t}(t,["own","capabilities","aud","req","iat","exp","type","nad","dad","iss","boxPub","verified"]),v=r.uportProfile;void 0===v&&(v={});var h=Object.assign({},{did:d,boxPub:l},n,v,f);u&&(h.deviceKey=u),c&&(h.mnid=c,h.address=a(c).address),1===o.length&&(h.pushToken=o[0]);var y=function(){if(p){var e=[],r=p.map(function(r){return s(r,{audience:i.did}).catch(function(){return e.push(r),Promise.resolve(void 0)})});return Promise.resolve(Promise.all(r)).then(function(r){var t=[];r.forEach(function(e){e&&t.push(Object.assign({},e.payload,{jwt:e.jwt}))}),h.verified=t,h.invalid=e})}}();return y&&y.then?y.then(function(){return h}):h}catch(e){return Promise.reject(e)}},m.prototype.authenticateDisclosureResponse=function(e,r){try{var t=this;return Promise.resolve(s(e,{audience:t.did,callbackUrl:r,auth:!0})).then(function(e){var r=e.payload,i=e.doc;if(r.req)return Promise.resolve(s(r.req,{audience:t.did})).then(function(e){var n=e.payload;if(n.type!==f.DISCLOSURE_REQUEST)throw new Error("Challenge payload type invalid: "+n.type);return t.processDisclosurePayload({payload:r,doc:i})});throw new Error("Challenge was not included in response")})}catch(e){return Promise.reject(e)}},m.prototype.verifyDisclosure=function(e){try{var r=this;return Promise.resolve(s(e,{audience:r.did})).then(function(e){return r.processDisclosurePayload({payload:e.payload,doc:e.doc})})}catch(e){return Promise.reject(e)}},m.prototype.contract=function(e){var r=this;return h(function(e,t){return e.function&&(e.fn=e.function),delete e.function,r.createTxRequest(e,t)}.bind(this))(e)};export{m as Credentials,h as ContractFactory};
//# sourceMappingURL=index.mjs.map
